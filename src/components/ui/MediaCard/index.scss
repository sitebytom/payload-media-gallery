// Item Styles
.media-gallery-grid {
  &__item-wrapper {
    position: relative;
    border: 1px solid transparent;
    z-index: 0;
    height: 100%; // Fill container (crucial for Justified layout)

    &:hover,
    &--selection-mode {
      .media-gallery-grid__controls,
      .media-gallery-grid__checkbox {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
        pointer-events: auto;
      }
      
      // Target the metadata overlay deeply nested
      .media-card__footer {
        opacity: 1 !important; // Force visibility on container hover
        transform: translateY(0) !important;
      }
    }

    @media (hover: none) and (pointer: coarse), (max-width: 768px) {
      .media-gallery-grid__controls,
      .media-gallery-grid__checkbox {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
        pointer-events: auto;
      }
      .media-card__footer {
        opacity: 1 !important;
        transform: translateY(0) !important;
      }
    }

    // Override the focus outline color at the wrapper level when selected
    &[aria-selected="true"] {
        --accessibility-outline: 2px solid var(--theme-success-600);
    }
  }

  &__checkbox {
    position: absolute;
    top: 0.6rem;
    left: 0.6rem;
    z-index: 21;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-4px);
    transition: opacity 0.25s cubic-bezier(0.19, 1, 0.22, 1), 
                transform 0.25s cubic-bezier(0.19, 1, 0.22, 1), 
                visibility 0.25s cubic-bezier(0.19, 1, 0.22, 1);
    flex-shrink: 0;

    .checkbox-input__input {
      width: 32px;
      height: 32px;
      border: 1px solid var(--theme-elevation-200);
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--theme-elevation-50);
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);

      .checkbox-input__icon {
        width: 20px;
        height: 20px;
      }
    }

      // Success tint when actually selected
      .media-gallery-grid__item-wrapper[aria-selected="true"] & {
        .checkbox-input__input {
          background: var(--theme-success-50);
          border-color: var(--theme-success-200);
          
          .checkbox-input__icon {
             color: var(--theme-success-600);
          }
        }
      }
  }

  &__controls {
      // LexicalEditorTheme__upload__overlay
      position: absolute;
      top: 0.6rem;
      right: 0.6rem;
      z-index: 22;
      
      // Initial state (hidden)
      opacity: 0;
      visibility: hidden;
      transform: translateY(-6px);
      pointer-events: none;
      transition: opacity .15s, transform .15s, visibility .15s;
      
      // Internal layout
      display: flex;
      align-items: center;
      gap: calc(var(--base) * .3);
      flex-wrap: nowrap;
      padding: calc(var(--base) * .1) calc(var(--base) * .1);
      
      // Visuals
      background: var(--theme-elevation-50);
      box-shadow: 0 -2px 16px -2px #0003;
      border-radius: 4px;
      border: 1px solid transparent; // Reserve space for selection border

      // Success tint when actually selected
      .media-gallery-grid__item-wrapper[aria-selected="true"] & {
        background: var(--theme-success-50);
        border: 1px solid var(--theme-success-200);
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);

        .media-gallery-grid__action-btn svg {
          color: var(--theme-success-800);
        }
      }
  }

  &__action-btn {
    // Lexical Button Reset
    --color: var(--theme-text);
    --bg-color: transparent;
    --hover-color: var(--theme-elevation-600);
    
    width: 28px;
    height: 28px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 3px;
    cursor: pointer;
    background: transparent;
    border: none;
    font-weight: 600;
    transition: background-color 0.1s ease;

    &:hover {
      background-color: var(--theme-elevation-200);
    }

    // Success tint hover when selected
    .media-gallery-grid__item-wrapper[aria-selected="true"] &:hover {
        background-color: var(--theme-success-200);
    }

    svg {
      width: 16px; // Standard icon size
      height: 16px;
      color: var(--theme-text);
    }
  }

  &__edit-btn {
    @extend .media-gallery-grid__action-btn;
  }

  &__expand-btn {
     @extend .media-gallery-grid__action-btn;
  }
  &__drag-handle {
    cursor: grab;
  }
  &__item {
    display: block;
    height: 100%;
    border-radius: 4px; // Ensure focus ring is rounded

    &:focus-visible,
    &--focused {
      outline: var(--accessibility-outline);
      outline-offset: 2px;
      
      // Remove any custom focus styles from the child card
      .media-card {
        box-shadow: none;
        border-color: var(--theme-elevation-200);
      }
    }

    .media-gallery-item__card-wrapper {
      height: 100%;
    }
  }
}

// Media Card - Shared Visual Logic
.media-card {
    // Base Styles
    border: 1px solid var(--theme-elevation-100); 
    background-color: var(--theme-elevation-0);
    border-radius: 4px; 
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden; 
    height: 100%; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.02); 
    transition: box-shadow 0.2s ease, border-color 0.2s ease;
    cursor: pointer;

    &:hover {
        border-color: var(--theme-elevation-200);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    // --- SHARED PREVIEW LOGIC ---
    &__preview {
        height: 100%;
        padding-bottom: 0;
        border-bottom: 0;
        z-index: 1;
        position: absolute; 
        top: 0;
        left: 0;
        width: 100%;
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 4px;
        
        img, video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .icon--document {
            height: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    }

    // --- SHARED FOOTER LOGIC ---
    &__footer {
        display: flex; 
        flex-wrap: nowrap; 
        align-items: center;
        justify-content: space-between; 
        text-align: left;
        gap: calc(var(--base) * .5);

        position: absolute;
        bottom: 0;
        left: 0; 
        right: 0;
        width: 100%;
        margin: 0;
        box-sizing: border-box; 
        padding: calc(var(--base) * .5) calc(var(--base) * .75);
        
        background: color-mix(in oklab, var(--theme-elevation-50) 55%, transparent);
        backdrop-filter: saturate(1.2) blur(8px);
        
        z-index: 10;
        pointer-events: none; 
        border-radius: 0;
        border-top: 1px solid transparent; // Placeholder for selection state

        // Default visibility (Shown)
        opacity: 1;
        transform: translateY(0);
        transition: opacity 0.25s cubic-bezier(0.19, 1, 0.22, 1), 
                    transform 0.25s cubic-bezier(0.19, 1, 0.22, 1);

        [data-theme='dark'] & {
            background: color-mix(in oklab, var(--theme-elevation-50) 55%, transparent);
        }
        
        .media-card__filename {
            white-space: nowrap;
            text-overflow: ellipsis;
            margin: 0;
            overflow: hidden;
            color: var(--theme-text);
            font-size: 1rem;
            font-weight: 600;
            text-decoration: underline;
            text-underline-offset: 2px;
            max-width: 100%; 
            min-width: 0;
            flex: 0 1 auto;
        }

        .media-card__label {
            color: var(--theme-elevation-500);
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: .9em;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .media-card__icon {
            display: none;
        }
    }

    // --- SELECTED STATE ---
    &--selected {
        --card-border-color: var(--theme-success-300);
        --card-bg-color: var(--theme-success-50);
        --card-preview-bg-color: var(--theme-success-50);
        --card-icon-dots-bg-color: var(--theme-success-50);
        --card-icon-dots-color: var(--theme-success-400);
        --card-titlebar-icon-color: var(--theme-success-800);
        --card-label-color: var(--theme-success-800);
        --card-preview-icon-color: var(--theme-success-800);
        --accessibility-outline: 2px solid var(--theme-success-600);
        --assigned-collections-color: var(--theme-success-850);

        border-color: var(--card-border-color) !important;
        background-color: var(--card-bg-color) !important;

        // Native Payload Selection Tinting for Preview Area
        .thumbnail:after {
            content: "";
            background: var(--theme-success-150);
            mix-blend-mode: hard-light;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 2;
        }
        .media-card__footer {
            opacity: 1 !important;
            transform: translateY(0) !important;
            border-top: 1px solid var(--card-border-color);
            background: color-mix(in oklab, var(--card-bg-color) 85%, transparent);
            backdrop-filter: saturate(1.2) blur(8px);
            z-index: 3;

            .media-card__filename {
                color: var(--card-titlebar-icon-color);
            }
            .media-card__label {
                color: var(--card-label-color);
            }
        }
        
        &:hover {
           border-color: var(--theme-success-400) !important;
        }
    }

    // Handle documents
    &:has(.media-card__preview .icon--document) {
        .media-card__preview {
            background-color: var(--card-preview-bg-color, var(--theme-elevation-50));
            .icon--document svg {
                width: 48px;
                height: 48px;
                color: var(--card-preview-icon-color, var(--theme-elevation-500));
            }
        }
    }

    .thumbnail {
        position: relative;
        height: 100%;
        width: 100%;
    }

    &__skeleton {
        position: absolute;
        inset: 0;
        z-index: 5;
        width: 100%;
        height: 100%;
    }
}

// Variant-Specific Overrides
.media-card--overlay {
    // Hide footer by default in overlay variant
    .media-card__footer {
        opacity: 0;
        transform: translateY(6px);
    }
    
    // Hover/Selection behavior is handled by parent grid item-wrapper
    // and the specific .media-card--selected block above.
}

.media-card--show-footer {
    .media-card__footer {
        opacity: 1 !important;
        transform: translateY(0) !important;
    }
}
